# 0811 DB ì—°ê²° ë° ê¸°ëŠ¥ ì¶”ê°€

# ìµœì¢…

1. GCP - ë§ˆë¦¬ì•„ DB - í”„ë¡œì íŠ¸ ì „ë¶€ ì—°ê²°í•¨
2. ì¶”ê°€, ìˆ˜ì •, ì‚­ì œ ê¸°ëŠ¥ êµ¬í˜„(dbì— ë°˜ì˜ ë¨)

[3ë°°ì†ì„. ì‘ë™ì´ ë„ˆë¬´ ì˜¤ë˜ê±¸ë¦¼;;;]

<p align="center">
<img width="80%" src="https://github.com/minjiKim87/SpringAWS_Study/assets/68892132/e32466b2-78ad-4d7b-84f8-2f1d6f64d3b9.gif"/>
</p>

[dbë‘ë„ ì—°ë™ ì˜ë¨]

<img width="50%" src="https://github.com/minjiKim87/SpringAWS_Study/assets/68892132/32abf1d2-5808-44a0-ac4c-57c1c86eba66.png"/>

# ê³¼ì •(ë¬¸ì œë“¤)

# 1. GCP

1. í•˜ì´ë””ì—ì„œ ì‚¬ìš©ìë‘ ì•”í˜¸ ë„£ì„ë•Œ í—·ê°ˆë ¸ìŒ

<img width="50%" src="https://github.com/minjiKim87/SpringAWS_Study/assets/68892132/169869d4-d62a-47e8-bff9-515cf2d1ff54.png"/>

![ì•Œë ¤ì¤€ ë•ë¶„ì— í•´ê²°í•¨]


<img width="50%" src="https://github.com/minjiKim87/SpringAWS_Study/assets/68892132/df32c518-896c-4986-82ec-766906d9d011.png"/>


1. ë°©í™”ë²½ ê·œì¹™ ì„¤ì • : ë¡œì»¬ ip ì£¼ì†Œ ê²¸ 0.0.0.0/0 ì„¤ì •
    1. VPC ë°©í™”ë²½ì´ ë°”ë¡œ ë³´ì—¬ì„œ ê±°ê¸°ë‹¤ê°€ ì„¤ì •ì„ í•´ì¤¬ì—ˆëŠ”ë°
    2. SQL-í•´ë‹¹ ì¸ìŠ¤í„´ìŠ¤-ìš”ì•½-ë„¤íŠ¸ì›Œí‚¹ì— ì¶”ê°€í•˜ëŠ” ê±°ì˜€ìŒ


<img width="50%" src="https://github.com/minjiKim87/SpringAWS_Study/assets/68892132/85948b60-c5d7-4719-9a1e-a934683bbd18.png"/>


<img width="50%" src="https://github.com/minjiKim87/SpringAWS_Study/assets/68892132/42eeb3d1-8b00-4a54-ab8d-7a39c95e1d45.png"/>


# 2. ìŠ¤í”„ë§ ë¶€íŠ¸ - ë§ˆë¦¬ì•„ DB ì—°ê²°

<aside>
ğŸ’¡ gcp-ë§ˆë¦¬ì•„ DB ì—°ê²°ì€ ëœ ìƒí™©.

ê·¸ëƒ¥ ë¡œì»¬ DB-ìŠ¤í”„ë§ë¶€íŠ¸ ì—°ê²°(JDBC)ë¡œ ë¨¼ì € í•˜ê³  gcpì—°ê²°ëœ ì™¸ë¶€ ë§ˆë¦¬ì•„ DBë‘ ìŠ¤í”„ë§ë¶€íŠ¸ ì—°ê²°(Repository JPA) ì§„í–‰

</aside>

## ê³µí†µ ë¬¸ì œ

1. ì´ê²ƒì €ê²ƒ ë³µë¶™í•˜ë‹¤ ë³´ë‹ˆ build.gradleì— h2 databseë¥¼ ì‚¬ìš©í•˜ë„ë¡ ë˜ì–´ ìˆì—ˆì–´ì„œ, ì§€ìš°ê³  ë§ˆë¦¬ì•„ dbë¡œ ë°”ê¿ˆ
2. application.yml( application. propertiesì—ì„œ í•˜ë‹¤ê°€ ë³€ê²½ ) ì—ë‹¤ê°€ ì •ë³´ ë„£ê¸° 
    1. ìœ„ì¹˜ê°€ test ë°‘ì˜ resourcesë¡œ ë˜ì–´ ìˆì—ˆì–´ì„œ ë˜ í—¤ë§´ â†’ mainì˜ resourcesë¡œ ë³€ê²½ğŸ˜‚
3. spring-session-jdbc ì˜¤ë¥˜
    1. ì—†ìœ¼ë©´ ìê¾¸ ì˜¤ë¥˜ ë„ì›Œì£¼ê¸¸ë˜ ì•„ë˜ê±¸ ë³µì‚¬í•´ì„œ í•˜ì´ë””sqlì—ì„œ ì•„ì˜ˆ ë§Œë“¤ì–´ì¤Œ
        
        ```java
        CREATE TABLE SPRING_SESSION (
            PRIMARY_ID CHAR(36) NOT NULL,
            SESSION_ID CHAR(36) NOT NULL,
            CREATION_TIME BIGINT NOT NULL,
            LAST_ACCESS_TIME BIGINT NOT NULL,
            MAX_INACTIVE_INTERVAL INT NOT NULL,
            EXPIRY_TIME BIGINT NOT NULL,
            PRINCIPAL_NAME VARCHAR(100),
            CONSTRAINT SPRING_SESSION_PK PRIMARY KEY (PRIMARY_ID)
        ) ENGINE=InnoDB ROW_FORMAT=DYNAMIC;
        
        CREATE UNIQUE INDEX SPRING_SESSION_IX1 ON SPRING_SESSION (SESSION_ID);
        CREATE INDEX SPRING_SESSION_IX2 ON SPRING_SESSION (EXPIRY_TIME);
        CREATE INDEX SPRING_SESSION_IX3 ON SPRING_SESSION (PRINCIPAL_NAME);
        
        CREATE TABLE SPRING_SESSION_ATTRIBUTES (
            SESSION_PRIMARY_ID CHAR(36) NOT NULL,
            ATTRIBUTE_NAME VARCHAR(200) NOT NULL,
            ATTRIBUTE_BYTES BLOB NOT NULL,
            CONSTRAINT SPRING_SESSION_ATTRIBUTES_PK PRIMARY KEY (SESSION_PRIMARY_ID, ATTRIBUTE_NAME),
            CONSTRAINT SPRING_SESSION_ATTRIBUTES_FK FOREIGN KEY (SESSION_PRIMARY_ID) REFERENCES SPRING_SESSION (PRIMARY_ID) ON DELETE CASCADE
        ) ENGINE=InnoDB ROW_FORMAT=DYNAMIC;
        ```
        
4. ê³„ì† ì¤‘ê°„ì¤‘ê°„ White Labelë¬¸ì œ  : ë§¤í•‘ ì—ëŸ¬ 
    1. ê²½ë¡œ ì„¤ì •ì„ ì œëŒ€ë¡œ í–ˆëŠ”ì§€ ì°¾ì•„ë´„
    2. ëŒ€ë¶€ë¶„ ì œëŒ€ë¡œ í–ˆëŠ”ë°, ê·¸ ë¬¸ì œê°€ ì•„ë‹ˆë¼ ì£¼ì†Œì°½ì—ì„œ ì ‘ê·¼í• ë•Œ â€¦/test/insertë¡œ í•˜ê²Œ ì½”ë“œë¥¼ ì§œë†¨ëŠ”ë° í•˜ë‹¤ë³´ë‹ˆê¹Œ ê¹Œë¨¹ê³  â€¦/insertë¡œ ê°€ì„œ ì•ˆë˜ëŠ” ê±°ì˜€ìŒ

<img width="50%" src="https://github.com/minjiKim87/SpringAWS_Study/assets/68892132/d29c0ed1-7aa2-4225-8789-d2d613381a6b.png"/>

```java
@GetMapping("/insert") //<- ì´ê²ƒì²˜ëŸ¼ ê²½ë¡œ ì„¤ì •
public String insert() {
    // ë¡œì§ ì²˜ë¦¬
    return "insertPage";
}
```

1. records í…Œì´ë¸”ë¡œ ë§Œë“¤ì–´ë†“ê³  RECORD í…Œì´ë¸”ë¡œ ì ‘ì†í•´ì„œ ê³„ì† ë¹ˆ í™”ë©´ ë„ì›Œì£¼ê¸°ë„ í–ˆìŒ ã…;;;
2. recordID, recordTitleë¡œ ì¼ëŠ”ë° idë‚˜ titleë¡œ ì¨ì„œ ë†“ì¹œë‹¤ë˜ì§€â€¦

## JDBC

- ì²˜ìŒì— repository í˜•ì‹ì´ ì•„ë‹ˆë¼ spring jdbcê°€ ë” ì§ê´€ì ì´ë¼(íŒŒì¼ì´ ë‘ê°œë§Œ í•„ìš”í•˜ê¸¸ë˜) ì—°ê²° í™•ì¸ ê²¸ ê·¸ê±¸ë¡œ ì§„í–‰í•¨
- ì´ ì½”ë“œë¡œëŠ” ìŠ¤í”„ë§ë¶€íŠ¸ - DB ì—°ê²° : GETë§Œ í™•ì¸
    - í•˜ì´ë””ì—ì„œ í…ŒìŠ¤íŠ¸ë¡œ ë„£ì–´ì£¼ê³ , ê·¸ ê°’ì„ [localhost:8080/fetch-dataì—ì„œ](http://localhost:8080/fetch-dataì—ì„œ) ì¡°íšŒë§Œ í•˜ëŠ” ê²ƒ.
- ë¡œì»¬ DBì—ì„œ ë˜ê³ , GCPë§ˆë¦¬ì•„ DBì—ì„œë„ ë˜ëŠ”ê²ƒ í™•ì¸

```java
CREATE TABLE `Records` (
	`record_id`	int	NOT NULL	COMMENT 'auto increment',
	`record_title`	varchar(255)	NOT NULL,
	`location`	varchar(255)	NOT NULL,
	`start_date`	date	NOT NULL,
	`end_date`	date	NOT NULL
);
```

```java
INSERT INTO `records` (`record_id`, `record_title`, `location`, `start_date`, `end_date`) VALUES
(1, 'ì„œìš¸ ì—¬í–‰', 'ì„œìš¸', '2023-09-01', '2023-09-05'),
(2, 'ë¶€ì‚° ë°”ë‹¤ íƒí—˜', 'ë¶€ì‚°', '2023-10-10', '2023-10-15'),
(3, 'ì œì£¼ë„ íë§', 'ì œì£¼ë„', '2023-11-05', '2023-11-10'),
(4, 'ê°•ì›ë„ ìŠ¤í‚¤ ì—¬í–‰', 'ê°•ì›ë„', '2024-01-15', '2024-01-20'),
(5, 'ê²½ì£¼ ì—­ì‚¬ íƒë°©', 'ê²½ì£¼', '2023-12-05', '2023-12-09');
```

`DatabaseController.java`

```java
package com.mycompany.myproject.web;

import com.mycompany.myproject.service.DatabaseService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

import java.util.List;
import java.util.Map;

@RestController
public class DatabaseController {

    @Autowired
    private DatabaseService databaseService;

    @GetMapping("/fetch-data")
    public List<Map<String, Object>> fetchData() {
        return databaseService.fetchAllTestData();
    }
}
```

`DatabaseService.java`

```java
package com.mycompany.myproject.service;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.stereotype.Service;

import java.util.List;
import java.util.Map;

@Service
public class DatabaseService {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    public List<Map<String, Object>> fetchAllTestData() {
        return jdbcTemplate.queryForList("SELECT * FROM RECORD");
    }
}
```

## Repository JPA í˜•ì‹

- GETì€ ë˜ê³ , POST/UPDATE/DELETEë¥¼ í• ë ¤ê³  í•¨

### POST

1. CSRF ë¹„í™œì„±í™” : ì´ê±¸ í•´ì•¼ì§€ postê°€ ëœë‹¤. 
    1. build.gradleì— ì¶”ê°€ : `implementation 'org.springframework.boot:spring-boot-starter-security'`
    2. WebSecurityConfig íŒŒì¼ ì¶”ê°€(ìë™ìœ¼ë¡œ ë§Œë“¤ì–´ì§„ë‹¤ë˜ë° ì•ˆë˜ê¸¸ë˜..)

<img width="50%" src="https://github.com/minjiKim87/SpringAWS_Study/assets/68892132/3cd812a2-3d81-49ec-8d3d-803f2596ab99.png"/>

```java
package com.mycompany.myproject.config;

import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;

@EnableWebSecurity
public class WebSecurityConfig extends WebSecurityConfigurerAdapter {
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http
                .csrf().disable()
                .authorizeRequests()
                .anyRequest().authenticated()
                .and()
                .formLogin().permitAll();
    }
}
```

â†’ post ì„±ê³µ, í•˜ì´ë””ì—ì„œë„ í™•ì¸ ê°€ëŠ¥ 

<img width="50%" src="https://github.com/minjiKim87/SpringAWS_Study/assets/68892132/6a98bf86-f8f3-4167-afa2-fa043f36db87.png"/>

### UPDATE/DELETE

tmpRecord.html í˜ì´ì§€ë¥¼ ë§Œë“¦

<img width="50%" src="https://github.com/minjiKim87/SpringAWS_Study/assets/68892132/ef40a0a3-6af3-496b-90cc-ac04ce45f486.png"/>

## ë~

### ì¶”ê°€

<img width="50%" src="https://github.com/minjiKim87/SpringAWS_Study/assets/68892132/bed16952-f3fa-470a-bf79-9fc88455fe72.png"/>
<img width="50%" src="https://github.com/minjiKim87/SpringAWS_Study/assets/68892132/a7b0fc9e-4e92-4123-b407-d1cf6c75cea7.png"/>

<img width="50%" src="https://github.com/minjiKim87/SpringAWS_Study/assets/68892132/2e94ce33-8a78-495e-8d85-e5f9be84f632.png"/>

### ìˆ˜ì •

<img width="50%" src="https://github.com/minjiKim87/SpringAWS_Study/assets/68892132/1bccf10b-728a-4625-a1e1-b04cefe3107a.png"/>

### ì‚­ì œ

<img width="50%" src="https://github.com/minjiKim87/SpringAWS_Study/assets/68892132/c02e56b2-6a70-4610-9887-6688da7173cf.png"/>
